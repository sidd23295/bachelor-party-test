<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kraken‚Äôs Bachelor Party HQ ‚Äì Access Gate</title>
  <style>
    :root{
      --bg:#07070a;
      --card: rgba(15,15,20,0.70);
      --border: rgba(255,255,255,0.10);
      --text:#f4f4f4;
      --muted:#bdbdbd;
      --neon1:#00f5ff;
      --neon2:#ff3df0;
      --neon3:#ffe66d;
      --good:#67ff7a;
      --bad:#ff5a5a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1000px 650px at 10% 0%, rgba(0,245,255,0.18), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(255,61,240,0.16), transparent 60%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,230,109,0.10), transparent 55%),
        linear-gradient(180deg, #06060a, #0a0a10);
      overflow:hidden;
    }
    .orb{
      position:absolute; width:280px; height:280px; border-radius:50%;
      filter:blur(50px); opacity:.35; mix-blend-mode:screen;
      animation: drift 14s ease-in-out infinite;
    }
    .orb.o1{background:var(--neon1); top:-90px; left:-70px;}
    .orb.o2{background:var(--neon2); top:10%; right:-100px; animation-delay:-4s;}
    .orb.o3{background:var(--neon3); bottom:-120px; left:20%; animation-delay:-7s;}
    @keyframes drift{
      0%{transform:translate(0,0) scale(1);}
      50%{transform:translate(40px,30px) scale(1.15);}
      100%{transform:translate(0,0) scale(1);}
    }

    .gridfx{
      position:fixed; inset:0; pointer-events:none; opacity:.26;
      background-image:
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
      background-size: 52px 52px;
      mask-image: radial-gradient(circle at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,0));
    }

    .wrap{
      position:relative;
      z-index:2;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .card{
      width:min(980px, 94vw);
      border-radius:22px;
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(0,0,0,0.65);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transform-style:preserve-3d;
      transition: transform .14s ease;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 20px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      flex-wrap:wrap;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:950;
      letter-spacing:.02em;
    }
    .brand .subbrand{
      color:rgba(255,255,255,0.78);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
    }

    .pill{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.04);
    }
    .btn{
      appearance:none;
      border:none;
      color:var(--text);
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition:transform .06s ease, background .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,0.12);}
    .btn:active{transform:scale(0.98);}
    .btn.primary{
      border-color: rgba(0,245,255,0.45);
      box-shadow: 0 0 0 3px rgba(0,245,255,0.10);
    }

    .content{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 980px){
      .content{grid-template-columns: 1fr; }
    }

    .panel{
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.18);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .panelHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
    }

    /* Gate hero branding */
    .gateHero{
      text-align:center;
      margin: 4px auto 12px;
      max-width: 60ch;
      position:relative;
    }
    .gateKicker{
      font-weight:1000;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.88);
      opacity:.95;
      animation: floaty 2.6s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0); opacity:.92; }
      50%{ transform: translateY(-6px); opacity:1; }
    }
    .gateTitle{
      margin-top:6px;
      font-size: clamp(34px, 4.2vw, 56px);
      font-weight: 1000;
      line-height: 1.02;
      background: linear-gradient(90deg, var(--neon1), var(--neon2), var(--neon3));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 18px rgba(0,245,255,0.16),
        0 0 32px rgba(255,61,240,0.10);
      position:relative;
    }
    .gateTitle::after{
      content:"";
      position:absolute;
      inset:-10px -16px;
      background: linear-gradient(90deg, transparent, rgba(0,245,255,0.14), rgba(255,61,240,0.12), transparent);
      transform: translateX(-140%);
      filter: blur(2px);
      animation: shimmer 4.8s ease-in-out infinite;
      pointer-events:none;
      opacity:.9;
    }
    @keyframes shimmer{
      0%{transform:translateX(-140%);}
      50%{transform:translateX(40%);}
      100%{transform:translateX(220%);}
    }
    .gateSub{
      margin-top:10px;
      color:#d7d7d7;
      font-weight:850;
      line-height:1.45;
      opacity:.95;
    }
    .gateDivider{
      width:min(520px, 86%);
      height:1px;
      margin:14px auto 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.20), transparent);
      position:relative;
    }

    /* Loading screen */
    .loadingStage{
      height: 420px;
      display:grid;
      place-items:center;
      padding:22px;
      position:relative;
    }
    .loadingBox{
      text-align:center;
      max-width:56ch;
    }
    .title{
      margin:10px 0 8px;
      font-size: clamp(24px, 3.0vw, 36px);
      font-weight:950;
      text-shadow: 0 0 14px rgba(0,245,255,0.14), 0 0 28px rgba(255,61,240,0.10);
    }
    .sub{
      margin:0 0 16px;
      color:#d6d6d6;
      line-height:1.55;
    }
    .sweep{
      position:relative;
      height:3px;
      width:min(520px,86%);
      margin:16px auto 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .sweep::after{
      content:"";
      position:absolute;
      inset:-2px 0;
      width:45%;
      background:linear-gradient(90deg, transparent, var(--neon1), var(--neon2), transparent);
      filter:blur(2px);
      animation:sweep 1.35s linear infinite;
    }
    @keyframes sweep{ 0%{transform:translateX(-120%);} 100%{transform:translateX(240%);} }

    .dots{display:flex; justify-content:center; gap:10px; margin:10px 0 18px;}
    .dot{width:10px;height:10px;border-radius:50%; background:var(--neon1); opacity:.8; animation:bounce 1s infinite ease-in-out; box-shadow:0 0 12px rgba(0,245,255,0.85);}
    .dot:nth-child(2){background:var(--neon2); animation-delay:.15s; box-shadow:0 0 12px rgba(255,61,240,0.85);}
    .dot:nth-child(3){background:var(--neon3); animation-delay:.30s; box-shadow:0 0 12px rgba(255,230,109,0.85);}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.55;} 40%{transform:translateY(-10px);opacity:1;}}

    /* Start button pulse */
    #startBtn{
      position:relative;
      animation: btnPulse 1.6s ease-in-out infinite;
    }
    @keyframes btnPulse{
      0%,100%{ transform: translateY(0); box-shadow: 0 0 0 3px rgba(0,245,255,0.10); }
      50%{ transform: translateY(-1px); box-shadow: 0 0 0 6px rgba(255,61,240,0.10); }
    }

    /* Game area */
    .arena{
      height: 420px;
      position:relative;
      user-select:none;
      touch-action: manipulation;
      background:
        radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,0.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.15));
    }
    .arena::after{
      content:"";
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity:.35;
      pointer-events:none;
      mask-image: radial-gradient(circle at center, rgba(0,0,0,1), rgba(0,0,0,0));
    }

    .hud{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.20);
      position:relative;
      z-index:3;
    }
    .stat{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      font-size:13px;
      color:#e9e9e9;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .stat b{font-weight:950;}
    .hint{color:var(--muted); font-size:12px; margin-left:auto;}

    .target{
      position:absolute;
      width:64px; height:64px;
      border-radius:50%;
      cursor:pointer;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at center, rgba(0,0,0,0) 38%, rgba(0,0,0,0.0) 39%),
        radial-gradient(circle at center, rgba(0,245,255,0.20), rgba(255,61,240,0.12));
      border:2px solid rgba(0,245,255,0.55);
      box-shadow:
        0 0 0 6px rgba(0,245,255,0.10),
        0 0 30px rgba(0,245,255,0.22),
        0 0 30px rgba(255,61,240,0.12);
      animation: pop .12s ease-out;
    }
    .target::before, .target::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.18);
    }
    .target::after{
      inset:22px;
      border-color: rgba(255,61,240,0.30);
    }
    @keyframes pop{ from{transform:translate(-50%,-50%) scale(.9); opacity:.6;} to{transform:translate(-50%,-50%) scale(1); opacity:1;}}

    .crosshair{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
    }
    .crosshair .v, .crosshair .h{
      position:absolute;
      background:rgba(255,255,255,0.08);
    }
    .crosshair .v{width:1px; top:0; bottom:0; left:50%;}
    .crosshair .h{height:1px; left:0; right:0; top:50%;}
    .toast{
      position:absolute;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.35);
      color:#f1f1f1;
      display:none;
      z-index:5;
      max-width: min(92%, 520px);
      text-align:center;
    }
    .toast.show{display:block; animation: toastIn .22s ease-out;}
    @keyframes toastIn{from{opacity:0; transform:translateX(-50%) translateY(6px);} to{opacity:1; transform:translateX(-50%) translateY(0);} }

    /* Right side panel */
    .side{ padding:14px; }
    .side h3{ margin:0 0 10px; font-size:18px; font-weight:950; }
    .side p{ margin:0 0 12px; color:#d2d2d2; line-height:1.55; }
    .rules{
      margin:12px 0 14px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:#ddd;
      font-size:14px;
    }
    .rules ul{margin:8px 0 0; padding-left:18px;}
    .rules li{margin:6px 0;}
    .small{ font-size:12px; color:var(--muted); line-height:1.5; margin-top:10px; }

    /* Overlay */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background:rgba(0,0,0,0.60);
      z-index:10;
      padding:18px;
    }
    .overlay.show{display:grid;}
    .modal{
      width:min(640px, 92vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(10,10,14,0.85);
      box-shadow:0 30px 80px rgba(0,0,0,0.7);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .modal h3{margin:8px 0 6px; font-size:24px; font-weight:950;}
    .modal p{margin:0 0 12px; color:#d7d7d7; line-height:1.5;}

    /* CAPTCHA grid */
    .captchaGrid{
      width:min(520px, 92vw);
      aspect-ratio: 1 / 1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      overflow:hidden;
      position:relative;
      background: rgba(0,0,0,0.25);
      margin-top:12px;
    }
    .captchaGrid img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
    }
    .captchaTiles{
      position:absolute;
      inset:0;
      display:grid;
      gap:2px;
      background: rgba(255,255,255,0.05);
    }
    .captchaTile{
      background: rgba(0,0,0,0.10);
      border: 1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      transition: background .12s ease, box-shadow .12s ease;
    }
    .captchaTile:hover{
      background: rgba(255,255,255,0.08);
      box-shadow: inset 0 0 0 2px rgba(0,245,255,0.20);
    }

    /* TAKE IT overlay */
    .takeItText{
      font-weight:1000;
      text-align:center;
      font-size: clamp(30px, 5vw, 64px);
      letter-spacing:.08em;
      text-transform:uppercase;
      text-shadow:
        0 0 18px rgba(0,245,255,0.20),
        0 0 30px rgba(255,61,240,0.15);
      animation: shake 0.18s infinite alternate, pulseGlow 1.1s infinite ease-in-out;
      margin:0;
    }
    .takeItSub{
      margin:10px 0 0;
      color:#d9d9d9;
      text-align:center;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      opacity:0.9;
    }
    @keyframes shake{
      from{ transform: translate(0,0) rotate(-0.4deg); }
      to{ transform: translate(2px,-1px) rotate(0.4deg); }
    }
    @keyframes pulseGlow{
      0%,100%{ filter: drop-shadow(0 0 12px rgba(0,245,255,0.18)); opacity:0.90; }
      50%{ filter: drop-shadow(0 0 22px rgba(255,61,240,0.20)); opacity:1; }
    }

    @media (prefers-reduced-motion: reduce){
      .orb,.gateKicker,.gateTitle::after,.sweep::after,.dot,#startBtn{ animation:none !important; }
      .card{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="orb o1"></div>
  <div class="orb o2"></div>
  <div class="orb o3"></div>
  <div class="gridfx"></div>

  <div class="wrap">
    <div class="card" id="tiltCard">
      <div class="topbar">
        <div class="brand">
          üêô Kraken‚Äôs Bachelor Party HQ
          <span class="pill">Access Gate</span>
          <span class="subbrand">clearance required</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="resetBtn" title="Resets unlock + score">Reset</button>
          <button class="btn primary" id="goIfUnlockedBtn" title="If already unlocked, go to HQ">Go to HQ</button>
        </div>
      </div>

      <div class="content">
        <!-- Left: stage -->
        <div class="panel">
          <div class="panelHeader">
            <h2 id="stageTitle">Initializing</h2>
            <span class="pill" id="stagePill">Loading</span>
          </div>

          <!-- Loading -->
          <div class="loadingStage" id="loadingStage">
            <div class="loadingBox">
              <div class="gateHero">
                <div class="gateKicker">üêô Kraken‚Äôs</div>
                <div class="gateTitle">Bachelor Party HQ</div>
                <div class="gateSub">Security clearance required. Chaos approved.</div>
                <div class="gateDivider"></div>
              </div>

              <div class="title">Booting the Weekend Plan</div>
              <p class="sub">
                Step 1: Hit <b>10 markers in a row</b>.<br/>
                Step 2: Pass the photo check.
              </p>
              <div class="sweep"></div>
              <div class="dots" aria-hidden="true">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
              </div>
              <button class="btn primary" id="startBtn">Start Challenge</button>
              <div class="small">Tip: Tap/click the glowing marker. Miss or timeout = streak resets.</div>
            </div>
          </div>

          <!-- Game -->
          <div class="arena" id="arena" style="display:none;">
            <div class="hud">
              <div class="stat">üéØ Streak: <b id="streak">0</b> / 10</div>
              <div class="stat">‚úÖ Hits: <b id="hits">0</b></div>
              <div class="stat">‚ùå Misses: <b id="misses">0</b></div>
              <div class="hint">Hit the marker before it times out.</div>
            </div>
            <div class="crosshair" aria-hidden="true"><div class="v"></div><div class="h"></div></div>
            <div class="toast" id="toast"></div>
          </div>
        </div>

        <!-- Right: instructions -->
        <div class="panel side">
          <h3>How it works</h3>
          <p>This is a fun ‚Äúdoor‚Äù into the real bachelor party page.</p>

          <!-- Rules pills removed (as requested) -->
          <div class="rules">
            <b>Step 1 ‚Äî Aim</b>
            <ul>
              <li>Hit 10 markers in a row.</li>
              <li>Miss (or timeout) resets streak to 0.</li>
            </ul>
            <div style="height:10px"></div>
            <b>Step 2 ‚Äî Photo Check</b>
            <ul>
              <li>Click the square containing the groom‚Äôs face.</li>
              <li>Wrong click sends you back.</li>
            </ul>
          </div>

          <div class="small">This is all local to the device (no server).</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CAPTCHA overlay -->
  <div class="overlay" id="captchaOverlay">
    <div class="modal" style="text-align:left;">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div>
          <span class="pill">Final Check</span>
          <h3 style="margin:8px 0 6px;">Pick the groom‚Äôs face</h3>
          <p style="margin:0 0 6px; color:#d7d7d7; line-height:1.45;">
            Click the square that contains the groom‚Äôs face to enter HQ.
          </p>
        </div>
        <button class="btn" id="captchaResetBtn" title="Reset and go back">Reset</button>
      </div>

      <div id="captchaWrap"></div>

      <div class="small" style="margin-top:10px;">
        Wrong click = back to the challenge.
      </div>
    </div>
  </div>

  <!-- TAKE IT overlay (5s) -->
  <div class="overlay" id="takeItOverlay">
    <div class="modal" style="background:rgba(0,0,0,0.55); border-color:rgba(255,255,255,0.10); text-align:center;">
      <p class="takeItText">TAKE IT TAKE IT TAKE IT</p>
      <p class="takeItSub">Entering HQ‚Ä¶</p>
    </div>
  </div>

  <script>
    // =========================
    // Config (tweak these)
    // =========================
    const REQUIRED_STREAK = 10;

    // Shooting difficulty
    const TARGET_TIMEOUT_MS = 1200; // easier: 1600, harder: 900
    const TARGET_SIZE_PX = 62;      // easier: 78, harder: 52

    // ---- CAPTCHA config ----
    const CAPTCHA_IMAGE_URL = "./assets/Photo4Party.jpeg";
    const CAPTCHA_GRID = 3;           // 3 => 3x3, 4 => 4x4
    const CAPTCHA_CORRECT_TILE = 5;   // <-- set this to the tile containing the groom

    // After correct captcha:
    const TAKE_IT_DURATION_MS = 5000;

    // =========================
    // Elements
    // =========================
    const loadingStage = document.getElementById('loadingStage');
    const arena = document.getElementById('arena');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const goIfUnlockedBtn = document.getElementById('goIfUnlockedBtn');

    const stageTitle = document.getElementById('stageTitle');
    const stagePill = document.getElementById('stagePill');

    const streakEl = document.getElementById('streak');
    const hitsEl = document.getElementById('hits');
    const missesEl = document.getElementById('misses');
    const toast = document.getElementById('toast');

    const captchaOverlay = document.getElementById("captchaOverlay");
    const captchaWrap = document.getElementById("captchaWrap");
    const captchaResetBtn = document.getElementById("captchaResetBtn");

    const takeItOverlay = document.getElementById("takeItOverlay");

    // Tilt
    const tiltCard = document.getElementById("tiltCard");
    const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    // =========================
    // State
    // =========================
    let streak = 0;
    let hits = 0;
    let misses = 0;
    let playing = false;

    let targetEl = null;
    let targetTimer = null;
    let targetActive = false;

    const UNLOCK_KEY = "bp_unlocked_v1";

    // =========================
    // Helpers
    // =========================
    function showToast(msg, good=true){
      toast.textContent = msg;
      toast.style.borderColor = good ? "rgba(103,255,122,0.35)" : "rgba(255,90,90,0.35)";
      toast.style.boxShadow = good ? "0 0 0 3px rgba(103,255,122,0.10)" : "0 0 0 3px rgba(255,90,90,0.10)";
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), 900);
    }

    function updateHUD(){
      streakEl.textContent = String(streak);
      hitsEl.textContent = String(hits);
      missesEl.textContent = String(misses);
    }

    function setStage(mode){
      if(mode === "loading"){
        stageTitle.textContent = "Initializing";
        stagePill.textContent = "Loading";
        loadingStage.style.display = "grid";
        arena.style.display = "none";
      } else {
        stageTitle.textContent = "Aim Trainer";
        stagePill.textContent = "Live";
        loadingStage.style.display = "none";
        arena.style.display = "block";
      }
    }

    function clearTarget(){
      if(targetTimer) clearTimeout(targetTimer);
      targetTimer = null;
      targetActive = false;
      if(targetEl){
        targetEl.remove();
        targetEl = null;
      }
    }

    function fail(reason){
      misses += 1;
      streak = 0;
      updateHUD();
      showToast(reason + " ‚Äî streak reset.", false);
    }

    // =========================
    // Shooting Game
    // =========================
    function spawnTarget(){
      clearTarget();

      const hudHeight = 52;
      const rect = arena.getBoundingClientRect();

      const minX = 40;
      const maxX = rect.width - 40;
      const minY = hudHeight + 60;
      const maxY = rect.height - 50;

      const x = Math.random() * (maxX - minX) + minX;
      const y = Math.random() * (maxY - minY) + minY;

      targetEl = document.createElement('div');
      targetEl.className = 'target';
      targetEl.style.width = TARGET_SIZE_PX + "px";
      targetEl.style.height = TARGET_SIZE_PX + "px";
      targetEl.style.left = x + "px";
      targetEl.style.top = y + "px";

      targetEl.addEventListener('click', (e) => {
        e.stopPropagation();
        if(!playing || !targetActive) return;

        targetActive = false;
        hits += 1;
        streak += 1;
        updateHUD();
        showToast("Hit! +" + 1, true);

        if(streak >= REQUIRED_STREAK){
          playing = false;
          clearTarget();
          showCaptcha();
          return;
        }

        setTimeout(spawnTarget, 140);
      });

      arena.appendChild(targetEl);
      targetActive = true;

      targetTimer = setTimeout(() => {
        if(!playing) return;
        clearTarget();
        fail("Too slow");
        setTimeout(spawnTarget, 200);
      }, TARGET_TIMEOUT_MS);
    }

    function startGame(){
      playing = true;
      streak = 0; hits = 0; misses = 0;
      updateHUD();
      setStage("game");
      showToast("Go. 10 in a row.", true);

      arena.onclick = () => {
        if(!playing) return;
        if(targetActive){
          clearTarget();
          fail("Miss");
          setTimeout(spawnTarget, 200);
        }
      };

      spawnTarget();
    }

    function resetAll(){
      localStorage.removeItem(UNLOCK_KEY);
      playing = false;
      clearTarget();
      captchaOverlay.classList.remove("show");
      takeItOverlay.classList.remove("show");
      streak = 0; hits = 0; misses = 0;
      updateHUD();
      setStage("loading");
      showToast("Reset complete.", true);
    }

    // =========================
    // CAPTCHA
    // =========================
    function showCaptcha(){
      captchaWrap.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "captchaGrid";

      const img = document.createElement("img");
      img.src = CAPTCHA_IMAGE_URL;
      img.alt = "Group photo";

      const tiles = document.createElement("div");
      tiles.className = "captchaTiles";
      tiles.style.gridTemplateColumns = `repeat(${CAPTCHA_GRID}, 1fr)`;
      tiles.style.gridTemplateRows = `repeat(${CAPTCHA_GRID}, 1fr)`;

      const total = CAPTCHA_GRID * CAPTCHA_GRID;

      for(let i=0; i<total; i++){
        const t = document.createElement("div");
        t.className = "captchaTile";
        t.title = `Tile ${i}`;

        t.addEventListener("click", () => {
          if(i === CAPTCHA_CORRECT_TILE){
            localStorage.setItem(UNLOCK_KEY, "true");
            captchaOverlay.classList.remove("show");
            showTakeItThenRedirect();
          } else {
            showToast("Wrong square ‚ùå Back to the challenge.", false);
            captchaOverlay.classList.remove("show");
            setStage("loading");
            streak = 0; hits = 0; misses = 0;
            updateHUD();
          }
        });

        tiles.appendChild(t);
      }

      grid.appendChild(img);
      grid.appendChild(tiles);
      captchaWrap.appendChild(grid);

      captchaOverlay.classList.add("show");
    }

    function showTakeItThenRedirect(){
      takeItOverlay.classList.add("show");
      setTimeout(() => {
        window.location.href = "./party.html";
      }, TAKE_IT_DURATION_MS);
    }

    captchaResetBtn.addEventListener("click", () => {
      captchaOverlay.classList.remove("show");
      setStage("loading");
      streak = 0; hits = 0; misses = 0;
      updateHUD();
      showToast("Reset. Try again.", true);
    });

    // =========================
    // Wiring
    // =========================
    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetAll);

    goIfUnlockedBtn.addEventListener('click', () => {
      if(localStorage.getItem(UNLOCK_KEY) === "true"){
        window.location.href = "./party.html";
      } else {
        showToast("Not unlocked yet. Beat the challenge.", false);
      }
    });

    // Init
    if(localStorage.getItem(UNLOCK_KEY) === "true"){
      stageTitle.textContent = "Welcome back";
      stagePill.textContent = "Unlocked";
      setStage("loading");
      setTimeout(() => showToast("Already unlocked. Tap ‚ÄúGo to HQ‚Äù.", true), 450);
    } else {
      setStage("loading");
    }

    // Parallax tilt
    if(!reduce){
      window.addEventListener("mousemove", (e) => {
        const r = tiltCard.getBoundingClientRect();
        const px = (e.clientX - (r.left + r.width/2)) / (r.width/2);
        const py = (e.clientY - (r.top + r.height/2)) / (r.height/2);
        const rx = (-py * 4);
        const ry = (px * 6);
        tiltCard.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
      });
      window.addEventListener("mouseleave", () => tiltCard.style.transform = "rotateX(0) rotateY(0)");
    }
  </script>
</body>
</html>
